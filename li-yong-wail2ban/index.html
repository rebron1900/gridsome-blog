<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>只是玩玩 | JUST FUN - 只是玩玩 | JUST FUN</title><meta name="gridsome:hash" content="0810a28e7848218696784bc8b33ad1e40c9e72dc"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Hello"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/gridsome-blog/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/gridsome-blog/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/gridsome-blog/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/gridsome-blog/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/gridsome-blog/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/gridsome-blog/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/gridsome-blog/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/gridsome-blog/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/gridsome-blog/assets/css/0.styles.be694e5c.css" as="style"><link rel="preload" href="/gridsome-blog/assets/js/app.ea73c485.js" as="script"><link rel="preload" href="/gridsome-blog/assets/js/page--src--templates--ghost-post-vue.0de93747.js" as="script"><link rel="prefetch" href="/gridsome-blog/assets/js/6.4b802b1d.js"><link rel="prefetch" href="/gridsome-blog/assets/js/page--node-modules--gridsome--app--pages--404-vue.5fb9a6b8.js"><link rel="prefetch" href="/gridsome-blog/assets/js/page--src--pages--index-copy-vue.caed7301.js"><link rel="prefetch" href="/gridsome-blog/assets/js/page--src--pages--index-vue.daf713f0.js"><link rel="stylesheet" href="/gridsome-blog/assets/css/0.styles.be694e5c.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body  class="darkmode">
    <main role="main" data-server-rendered="true" id="app" class="container"><div class="row"><header class="header"><a href="/gridsome-blog/" class="active"><h1>👨‍💻 只是玩玩 | JUST FUN</h1></a><!----></header><div class="article"><h1 class="article-title">服务器安全加固</h1><p class="article-date"> 1 October 2020 · <i> min read</i></p><article><p>昨天服务器又出大问题了，我几乎折腾了一整天，今天总结一下。</p><p>这次的问题还是和上次一样——被挂马当矿机了。观察了一下那个木马程序的运行逻辑如下，特点如下：wwwu'fa</p><ol><li>无法清除，会通过某种手段自动生成</li><li>打开资源管理器后会自我关闭，关闭资源管理器后不久又会自动运行</li><li>随机选择目录，并自我命名冒充关键程序</li></ol><p>综上所属，最开始打算利用火绒的规则程序阻止文件生成的方案应该是行不通了。后来尝试了不同的杀毒软件：node32，火绒，360，小红伞，虽然能识别病毒文件，但是无法解决自动生成的源头。</p><p>之后又在网上找资料，试用了一款叫<a href="http://www.safedog.cn/?ref=1900.live">安全狗</a>的针对服务器的防护软件，但是已经有将近两年没更新了。</p><figure class="kg-card kg-gallery-card kg-width-wide"><div class="kg-gallery-container"><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="https://cdn.1900.live/2020/10/------_16015366838073.png" width="903" height="603" loading="lazy" alt></div><div class="kg-gallery-image"><img src="https://cdn.1900.live/2020/10/------_20201001151826.png" width="901" height="605" loading="lazy" alt></div></div><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="https://cdn.1900.live/2020/10/------_20201001151838.png" width="902" height="600" loading="lazy" alt></div><div class="kg-gallery-image"><img src="https://cdn.1900.live/2020/10/------_20201001151900.png" width="898" height="600" loading="lazy" alt></div></div></div></figure><p>软件的功能还挺强大的，可以对整个服务器进行自检，做一些降权，端口，常见攻击的防护，用这个软件当天晚上处理完后等了一个小时左右服务器CPU占用都没有异常，想这应该是差不多了把？但是...，回家睡醒后第二天早上，公司打电话来说服务器宕机了，公司内部erp连不上，幸好我们公司是分布式的，总部出问题不太影响门店的主要共能使用。</p><p>睡得迷迷糊糊的我立马起床洗漱去了公司。看了眼服务器，电源什么都是通的，但是远程连不上，所以准备接显示器看看，但是发现vga接口好像松掉了，接上也不显示画面，尝试了很久都不行，没办法只能拿去电脑城了。</p><p>电脑城的邱哥说vga接口可能是针脚断了，而且我这个vga口子比较短，没法重新焊，所以给我拿了张亮机卡先开机。按下开机键后终于有画面了，但是自检完后到window进度条哪里，进度条走了2圈后就变黑了，是那种屏幕通电也有信号，但是画面是黑的那种。我想这种就是宕机的问题了把。试了下安全模式是可以进系统的，说明应该是程序问题，我自己觉得有可能是安全狗的某项优化服务器导致的（这个猜测应该没错，我后来仔细看了每一项优化内容，有一项是移除shell32.dll这个文件，我查了下这个文件丢失会导致桌面进不去）。</p><p>中途出去吃饭，发现还吃了张罚单，fuck！！！</p><p>后来试了一两个小时，实在没办法，重装吧~。</p><p>至于为什么没有一开始就选择重装，主要是公司erp搭建在上面，虽然我自己也能搭（之前我复制了他们公司的加密狗后自己安装软件和数据库后是可以用的），但是觉得挺麻烦的，iis，映射，数据库等等全要重新搞。</p><p>不过也没办法，搞吧。</p><p>昨天大致弄完已经是晚上11点49了，这次的安全软件是安全狗+node32，安全狗没有优化shell32.dll那个选项，系统重启后正常启动。但是在安装软件期间发现安全狗和node32频繁提示sqlserver的1433端口被攻击，但都被拦截了，而且挺晚的了就没管了直接回家休息了。</p><p>早上仔细想了想，上次被挂马找火绒的人看过后当时就和我说过，我这个问题是数据库被攻破后被黑的。所以这次重装想认真把这个事情处理一下。</p><p>找了很多资料，做了以下几项措施i</p><ol><li>开启防火墙</li><li>隐藏sqlserver实例，防止被探测</li><li>防火墙禁用1434端口</li><li>使用wail2ban自动ban掉频繁攻击的ip</li></ol><p>本来想改掉1433端口的，但是看了很多资料说这个方法基本没用，还是能扫描到。</p><figure class="kg-card kg-gallery-card kg-width-wide"><div class="kg-gallery-container"><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="https://cdn.1900.live/2020/10/------_20201001160230.png" width="669" height="431" loading="lazy" alt></div><div class="kg-gallery-image"><img src="https://cdn.1900.live/2020/10/------_20201001160303.png" width="620" height="385" loading="lazy" alt></div></div></div></figure><p><a href="https://github.com/glasnt/wail2ban?ref=1900.live">wail2ban</a>这个软件是基于linux上一个叫fial2ban的软件开发的防护软件，共能就是自动禁用掉指定阈值内频繁访问的ip。</p><p>github上没写的很清楚所以自己还是查了不少资料才搞明白原理，这个软件主要是通过读取windows日志来记录那些ip在如果在一定时间内频繁访问、暴力登录数据库的（现在还没弄明白这个一定时间有多长，想改长一点，十分钟什么的）就会自动编写一些防火墙规则ban掉这个ip，具体使用方法如下：</p><ol><li>在github上下载整个目录</li><li>以 C:\scripts\wail2ban的结构放在C盘下面 </li><li>如果你想自动启动可以在windows的任务计划里导入start wail2ban onstartup.xml这个文件生成启动计划</li><li>运行start wail2ban.bat执行程序</li></ol><p>注意，如果你是一次执行pwoershell程序可能会无法运行，需要在pwoershell里提成一下执行策略，具体操作我就不贴了，看<a href="https://www.cnblogs.com/wswind/p/10911286.html?ref=1900.live">https://www.cnblogs.com/wswind/p/10911286.html</a> 这个博友写的。</p><p>然后打开wail2ban_config.txt，里面对应了windows日志里的几个分类，分别是：应用程序，安全，安装，系统，你可以在日志里查看对应的事件代码后写在config里，格式就是前面是代码后面是你自己写的名字就ok了。</p></article></div><div class="footer"><div><p>
          Built with
          <a target="_blank" href="//gridsome.org" class="link">Gridsome</a>
          &amp; Made with ❤️ by
          <a target="_blank" href="//alex.design" class="link">Alex Brown</a></p></div><div class="footer-links"><a target="_blank" href="/sitemap.xml">Sitemap</a><a target="_blank" href="/feed.xml">RSS Feed</a></div></div></div></main>
    <script>window.__INITIAL_STATE__={"data":{"metadata":{"siteName":"只是玩玩 | JUST FUN","siteDescription":"Hello"},"post":{"id":"63158312cf533d1c2cf29b2b","title":"服务器安全加固","content":"\u003Cp\u003E昨天服务器又出大问题了，我几乎折腾了一整天，今天总结一下。\u003C\u002Fp\u003E\u003Cp\u003E这次的问题还是和上次一样——被挂马当矿机了。观察了一下那个木马程序的运行逻辑如下，特点如下：wwwu'fa\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E无法清除，会通过某种手段自动生成\u003C\u002Fli\u003E\u003Cli\u003E打开资源管理器后会自我关闭，关闭资源管理器后不久又会自动运行\u003C\u002Fli\u003E\u003Cli\u003E随机选择目录，并自我命名冒充关键程序\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E综上所属，最开始打算利用火绒的规则程序阻止文件生成的方案应该是行不通了。后来尝试了不同的杀毒软件：node32，火绒，360，小红伞，虽然能识别病毒文件，但是无法解决自动生成的源头。\u003C\u002Fp\u003E\u003Cp\u003E之后又在网上找资料，试用了一款叫\u003Ca href=\"http:\u002F\u002Fwww.safedog.cn\u002F?ref=1900.live\"\u003E安全狗\u003C\u002Fa\u003E的针对服务器的防护软件，但是已经有将近两年没更新了。\u003C\u002Fp\u003E\u003Cfigure class=\"kg-card kg-gallery-card kg-width-wide\"\u003E\u003Cdiv class=\"kg-gallery-container\"\u003E\u003Cdiv class=\"kg-gallery-row\"\u003E\u003Cdiv class=\"kg-gallery-image\"\u003E\u003Cimg src=\"https:\u002F\u002Fcdn.1900.live\u002F2020\u002F10\u002F------_16015366838073.png\" width=\"903\" height=\"603\" loading=\"lazy\" alt\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"kg-gallery-image\"\u003E\u003Cimg src=\"https:\u002F\u002Fcdn.1900.live\u002F2020\u002F10\u002F------_20201001151826.png\" width=\"901\" height=\"605\" loading=\"lazy\" alt\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"kg-gallery-row\"\u003E\u003Cdiv class=\"kg-gallery-image\"\u003E\u003Cimg src=\"https:\u002F\u002Fcdn.1900.live\u002F2020\u002F10\u002F------_20201001151838.png\" width=\"902\" height=\"600\" loading=\"lazy\" alt\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"kg-gallery-image\"\u003E\u003Cimg src=\"https:\u002F\u002Fcdn.1900.live\u002F2020\u002F10\u002F------_20201001151900.png\" width=\"898\" height=\"600\" loading=\"lazy\" alt\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E软件的功能还挺强大的，可以对整个服务器进行自检，做一些降权，端口，常见攻击的防护，用这个软件当天晚上处理完后等了一个小时左右服务器CPU占用都没有异常，想这应该是差不多了把？但是...，回家睡醒后第二天早上，公司打电话来说服务器宕机了，公司内部erp连不上，幸好我们公司是分布式的，总部出问题不太影响门店的主要共能使用。\u003C\u002Fp\u003E\u003Cp\u003E睡得迷迷糊糊的我立马起床洗漱去了公司。看了眼服务器，电源什么都是通的，但是远程连不上，所以准备接显示器看看，但是发现vga接口好像松掉了，接上也不显示画面，尝试了很久都不行，没办法只能拿去电脑城了。\u003C\u002Fp\u003E\u003Cp\u003E电脑城的邱哥说vga接口可能是针脚断了，而且我这个vga口子比较短，没法重新焊，所以给我拿了张亮机卡先开机。按下开机键后终于有画面了，但是自检完后到window进度条哪里，进度条走了2圈后就变黑了，是那种屏幕通电也有信号，但是画面是黑的那种。我想这种就是宕机的问题了把。试了下安全模式是可以进系统的，说明应该是程序问题，我自己觉得有可能是安全狗的某项优化服务器导致的（这个猜测应该没错，我后来仔细看了每一项优化内容，有一项是移除shell32.dll这个文件，我查了下这个文件丢失会导致桌面进不去）。\u003C\u002Fp\u003E\u003Cp\u003E中途出去吃饭，发现还吃了张罚单，fuck！！！\u003C\u002Fp\u003E\u003Cp\u003E后来试了一两个小时，实在没办法，重装吧~。\u003C\u002Fp\u003E\u003Cp\u003E至于为什么没有一开始就选择重装，主要是公司erp搭建在上面，虽然我自己也能搭（之前我复制了他们公司的加密狗后自己安装软件和数据库后是可以用的），但是觉得挺麻烦的，iis，映射，数据库等等全要重新搞。\u003C\u002Fp\u003E\u003Cp\u003E不过也没办法，搞吧。\u003C\u002Fp\u003E\u003Cp\u003E昨天大致弄完已经是晚上11点49了，这次的安全软件是安全狗+node32，安全狗没有优化shell32.dll那个选项，系统重启后正常启动。但是在安装软件期间发现安全狗和node32频繁提示sqlserver的1433端口被攻击，但都被拦截了，而且挺晚的了就没管了直接回家休息了。\u003C\u002Fp\u003E\u003Cp\u003E早上仔细想了想，上次被挂马找火绒的人看过后当时就和我说过，我这个问题是数据库被攻破后被黑的。所以这次重装想认真把这个事情处理一下。\u003C\u002Fp\u003E\u003Cp\u003E找了很多资料，做了以下几项措施i\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E开启防火墙\u003C\u002Fli\u003E\u003Cli\u003E隐藏sqlserver实例，防止被探测\u003C\u002Fli\u003E\u003Cli\u003E防火墙禁用1434端口\u003C\u002Fli\u003E\u003Cli\u003E使用wail2ban自动ban掉频繁攻击的ip\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E本来想改掉1433端口的，但是看了很多资料说这个方法基本没用，还是能扫描到。\u003C\u002Fp\u003E\u003Cfigure class=\"kg-card kg-gallery-card kg-width-wide\"\u003E\u003Cdiv class=\"kg-gallery-container\"\u003E\u003Cdiv class=\"kg-gallery-row\"\u003E\u003Cdiv class=\"kg-gallery-image\"\u003E\u003Cimg src=\"https:\u002F\u002Fcdn.1900.live\u002F2020\u002F10\u002F------_20201001160230.png\" width=\"669\" height=\"431\" loading=\"lazy\" alt\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"kg-gallery-image\"\u003E\u003Cimg src=\"https:\u002F\u002Fcdn.1900.live\u002F2020\u002F10\u002F------_20201001160303.png\" width=\"620\" height=\"385\" loading=\"lazy\" alt\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fglasnt\u002Fwail2ban?ref=1900.live\"\u003Ewail2ban\u003C\u002Fa\u003E这个软件是基于linux上一个叫fial2ban的软件开发的防护软件，共能就是自动禁用掉指定阈值内频繁访问的ip。\u003C\u002Fp\u003E\u003Cp\u003Egithub上没写的很清楚所以自己还是查了不少资料才搞明白原理，这个软件主要是通过读取windows日志来记录那些ip在如果在一定时间内频繁访问、暴力登录数据库的（现在还没弄明白这个一定时间有多长，想改长一点，十分钟什么的）就会自动编写一些防火墙规则ban掉这个ip，具体使用方法如下：\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E在github上下载整个目录\u003C\u002Fli\u003E\u003Cli\u003E以 C:\\scripts\\wail2ban的结构放在C盘下面 \u003C\u002Fli\u003E\u003Cli\u003E如果你想自动启动可以在windows的任务计划里导入start wail2ban onstartup.xml这个文件生成启动计划\u003C\u002Fli\u003E\u003Cli\u003E运行start wail2ban.bat执行程序\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E注意，如果你是一次执行pwoershell程序可能会无法运行，需要在pwoershell里提成一下执行策略，具体操作我就不贴了，看\u003Ca href=\"https:\u002F\u002Fwww.cnblogs.com\u002Fwswind\u002Fp\u002F10911286.html?ref=1900.live\"\u003Ehttps:\u002F\u002Fwww.cnblogs.com\u002Fwswind\u002Fp\u002F10911286.html\u003C\u002Fa\u003E 这个博友写的。\u003C\u002Fp\u003E\u003Cp\u003E然后打开wail2ban_config.txt，里面对应了windows日志里的几个分类，分别是：应用程序，安全，安装，系统，你可以在日志里查看对应的事件代码后写在config里，格式就是前面是代码后面是你自己写的名字就ok了。\u003C\u002Fp\u003E","date":"1 October 2020","path":"li-yong-wail2ban"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/gridsome-blog/assets/js/app.ea73c485.js" defer></script><script src="/gridsome-blog/assets/js/page--src--templates--ghost-post-vue.0de93747.js" defer></script>
  </body>
</html>