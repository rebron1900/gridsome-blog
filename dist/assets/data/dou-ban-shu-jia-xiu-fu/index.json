{"hash":"c172d95f3caedc458b15c41bd34a3ceddae884e7","data":{"metadata":{"siteName":"只是玩玩 | JUST FUN","siteDescription":"/gridsome-blog"},"post":{"id":"63158312cf533d1c2cf29aec","title":"豆瓣书架修复","content":"<!--kg-card-begin: markdown--><p>之前博客有做过一个豆瓣书架的功能，可以显示你再豆瓣的<code>想读</code>、<code>在读</code>、<code>已读</code>的三种状态的书籍信息。不过后来因为豆瓣改了API后增加了防盗链，导致所有的图片都因为403后无法加载后去掉了这个功能。</p>\n<p>不过因为前天决定开始做一个每月读一本书的计划，所以想重新修复下这个功能，之前自己研究了很久也没解决这个问题，因为这个是豆瓣那边的问题，人家防盗链了你没办法呀。今天百度了蛮久后，无意间看到<a href=\"https://blog.csdn.net/jsyxiaoba/article/details/79628983?ref=1900.live\">vue调用豆瓣API加载图片403问题</a>这篇文章，作者绕过豆瓣那边利用第三方的缓存服务来解决这个问题。</p>\n<p>使用起来很简单，把所有有防盗链的图片地址前面统一加上<code>https://images.weserv.nl/?url=</code>，利用这个服务进行图片中转就可以正常显示图片了，后来把相关代码做了下修改，修复了该功能，具体效果参见<a href=\"https://1900.live/books\">BOOKS</a>。</p>\n<p>步骤有点多，嫌麻烦，我就不一一说具体实现了，直接贴下所有的代码吧。<br>\n如果有问题可以留言问，我尽量解答...</p>\n<p>样式文件：<code>https://1900.live/assets/css/doubanbooks.css?v=d657e41618</code></p>\n<p>Page页面代码</p>\n<pre><code>&lt;div class=&quot;douban-books&quot;&gt;\n  &lt;!-- 正在读 --&gt;\n  &lt;div class=&quot;db-status-reading&quot;&gt;\n    &lt;div class=&quot;loading&quot;&gt;&lt;/div&gt;\n    &lt;h3 class=&quot;db-status-title&quot;&gt;在读的书&lt;/h3&gt;\n    &lt;ul id=&quot;db-reading-books&quot; class=&quot;db-books&quot;&gt;\n      &lt;script id=&quot;reading-template&quot; type=&quot;text/x-handlebars-template&quot;&gt;\n        {{#each this}}\n          &lt;li&gt;\n            &lt;a href=&quot;{{book.alt}}&quot; target=&quot;_blank&quot;&gt;\n              &lt;img src=&quot;{{book.images.medium}}&quot; /&gt;\n              &lt;span&gt;{{book.title}}&lt;/span&gt;\n            &lt;/a&gt;\n          &lt;/li&gt;\n        {{/each}}\n      &lt;/script&gt;\n    &lt;/ul&gt;\n  &lt;/div&gt;\n\n  &lt;!-- 想读的 --&gt;\n  &lt;div class=&quot;db-status-wish&quot;&gt;\n    &lt;div class=&quot;loading&quot;&gt;&lt;/div&gt;\n    &lt;h3 class=&quot;db-status-title&quot;&gt;想读的书&lt;/h3&gt;\n    &lt;ul id=&quot;db-wish-books&quot; class=&quot;db-books&quot;&gt;\n      &lt;script id=&quot;wish-template&quot; type=&quot;text/x-handlebars-template&quot;&gt;\n        {{#each this}}\n          &lt;li&gt;\n            &lt;a href=&quot;{{book.alt}}&quot; target=&quot;_blank&quot;&gt;\n              &lt;img src=&quot;{{book.images.medium}}&quot; /&gt;\n              &lt;span&gt;{{book.title}}&lt;/span&gt;\n            &lt;/a&gt;\n          &lt;/li&gt;\n        {{/each}}\n      &lt;/script&gt;\n    &lt;/ul&gt;\n  &lt;/div&gt;\n\n  &lt;!-- 读过的 --&gt;\n  &lt;div class=&quot;db-status-read&quot;&gt;\n    &lt;div class=&quot;loading&quot;&gt;&lt;/div&gt;\n    &lt;h3 class=&quot;db-status-title&quot;&gt;读过的书&lt;/h3&gt;\n    &lt;ul id=&quot;db-read-books&quot; class=&quot;db-books&quot;&gt;\n      &lt;script id=&quot;read-template&quot; type=&quot;text/x-handlebars-template&quot;&gt;\n        {{#each this}}\n          &lt;li&gt;\n            &lt;a href=&quot;{{book.alt}}&quot; target=&quot;_blank&quot;&gt;\n              &lt;img src=&quot;{{book.images.medium}}&quot; /&gt;\n              &lt;span&gt;{{book.title}}&lt;/span&gt;\n            &lt;/a&gt;\n          &lt;/li&gt;\n        {{/each}}\n      &lt;/script&gt;\n    &lt;/ul&gt;\n  &lt;/div&gt;\n\n  \n  \n&lt;/div&gt;\n\n&lt;!-- Script --&gt;\n&lt;script src=&quot;http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.1/jquery.min.js&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0-rc.4/handlebars.min.js&quot;&gt;&lt;/script&gt;\n&lt;!-- 引入要主js文件，地址根据你的情况填写。内容就是下面这个代码段 --&gt;\n&lt;script src=&quot;/assets/js/doubanbooks.js&quot;&gt;&lt;/script&gt;\n</code></pre>\n<p>js文件内容</p>\n<pre><code>(function() {\n  var DoubanBooks = {\n    init: function(opt) {\n      var apikey = opt.apikey ? '&amp;apikey=' + opt.apikey : '';\n      this.url = 'https://api.douban.com/v2/book/user/' + opt.username + '/collections?count=20' + apikey + '&amp;callback=?';\n      this.fetch();      \n    },\n    template: function(type, obj) {\n      var tmpl = $('#' + type + '-template').html(),\n          ctnr = $('#db-' + type + '-books');\n      // 编译模版\n      var _tmpl = Handlebars.compile(tmpl);\n      \n      $(&quot;.loading&quot;).hide();\n      ctnr.append(_tmpl(obj));\n    },\n    fetch: function() {\n      var self = this;\n      // 获取 JSON 数据\n      $.getJSON(this.url, function(data) {\n        data = data.collections;\n        $.map(data, function(book) {\n          //对获取到的豆瓣JSON数据里的图片地址进行修改\n          book.book.images.medium = 'https://images.weserv.nl/?url=' + book.book.images.medium;\n          switch(book.status) {\n            case &quot;wish&quot;:\n              self.wishBooks = [book];\n              self.template('wish', self.wishBooks);\n              break;\n            case &quot;reading&quot;:\n              self.readingBooks = [book];\n              self.template('reading', self.readingBooks);\n              break;\n            case &quot;read&quot;:\n              self.readBooks = [book];\n              self.template('read', self.readBooks);\n              break;\n          };\n        });\n      });   \n    }\n  };\n  DoubanBooks.init({\n    //设置豆瓣用户名\n    username: 'trax.long', // 豆瓣用户名\n    apikey: ''\n  });\n})();\n</code></pre>\n<!--kg-card-end: markdown-->","date":"27 September 2018","path":"dou-ban-shu-jia-xiu-fu"}},"context":{}}