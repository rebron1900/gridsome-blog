{"hash":"0810a28e7848218696784bc8b33ad1e40c9e72dc","data":{"metadata":{"siteName":"只是玩玩 | JUST FUN","siteDescription":"Hello"},"post":{"id":"63158312cf533d1c2cf29b15","title":"Ghost博客升级出错无法启动修复","content":"<p>由于Ghost没有自动更新系统，并保持在最新版本的功能，所以每次升级都需要用ssh登陆主机执行 <code>ghost update</code> 指令（以前后台的about里是不是有一个按钮点了就能升级？我刚刚去看好像没了）。不过好在用 <code>ghost-cli</code> 套件升级起来到是还简单方便。</p><p>今天像往常一样执行完命令，第一次执行时提示ghost-cli版本过低，不过命令还是能正常执行，但是在最后build完库之后在restart的步骤忽然卡出了，起初没在意，便放在这里忙其他的去了，忙完回来后却发现升级失败，出问题的步骤就是最后的restart的时候，报错如下：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-shell\">Debug Information:\nOS: Ubuntu, v16.04\nNode Version: v8.15.0\nGhost-CLI Version: 1.11.0\nEnvironment: production\nCommand: 'ghost update'\nMessage: Could not communicate with Ghost\nSuggestion: journalctl -u ghost_www-4zen-top -n 50\nStack: Error: Could not communicate with Ghost\nat Server.server.close (/usr/local/lib/node_modules/ghost-cli/lib/utils/port-polling.js:56:20)\nat Object.onceWrapper (events.js:313:30)\nat emitNone (events.js:106:13)\nat Server.emit (events.js:208:7)\nat emitCloseNT (net.js:1664:8)\nat _combinedTickCallback (internal/process/next_tick.js:136:11)\nat process._tickCallback (internal/process/next_tick.js:181:9)\n\nubuntu@VM-98-64-ubuntu:/var/www/ghost$ journalctl -u ghost_www-4zen-top -n 50\n-- Logs begin at Fri 2019-10-04 11:30:25 CST, end at Fri 2019-10-04 11:40:38 CST. --\nOct 04 11:34:26 VM-98-64-ubuntu systemd[1]: Stopped Ghost systemd service for blog: www-4zen-top.\nOct 04 11:34:26 VM-98-64-ubuntu systemd[1]: Started Ghost systemd service for blog: www-4zen-top.\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: /var/www/ghost/versions/2.31.1/node_modules/knex/lib/client.js:258\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: return this.acquireRawConnection().then(async (connection) =&gt; {\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: ^\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: SyntaxError: Unexpected token (\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at createScript (vm.js:56:10)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Object.runInThisContext (vm.js:97:10)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Module._compile (module.js:549:28)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Object.Module._extensions..js (module.js:586:10)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Module.load (module.js:494:32)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at tryModuleLoad (module.js:453:12)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Function.Module._load (module.js:445:3)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Module.require (module.js:504:17)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at require (internal/module.js:20:19)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Object. (/var/www/ghost/versions/2.31.1/node_modules/knex/lib/knex.js:2:16)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Module._compile (module.js:577:32)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Object.Module._extensions..js (module.js:586:10)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Module.load (module.js:494:32)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at tryModuleLoad (module.js:453:12)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Function.Module._load (module.js:445:3)\nOct 04 11:34:27 VM-98-64-ubuntu node[3469]: at Module.require (module.js:504:17)</code></pre><figcaption>报错信息&nbsp;</figcaption></figure><p>之后我用run命令单独执行ghost后程序正常运行，看来程序已经正常升级，只是systemd保持进程时出了问题。</p><p>自己研究了一阵后无果，便想着去github上 发条issue，看有没有人能帮到我——很可惜，等了半小时都没有答复。</p><figure class=\"kg-card kg-bookmark-card\"><a class=\"kg-bookmark-container\" href=\"https://github.com/TryGhost/Ghost/issues/11199?ref=1900.live\"><div class=\"kg-bookmark-content\"><div class=\"kg-bookmark-title\">Restart after the upgrade is complete · Issue #11199 · TryGhost/Ghost</div><div class=\"kg-bookmark-description\">Debug Information: OS: Ubuntu, v16.04 Node Version: v8.15.0 Ghost-CLI Version: 1.11.0 Environment: production Command: &amp;#39;ghost update&amp;#39; Message: Could not communicate with Ghost Suggestion: j...</div><div class=\"kg-bookmark-metadata\"><img class=\"kg-bookmark-icon\" src=\"https://github.githubassets.com/favicon.ico\" alt><span class=\"kg-bookmark-author\">GitHub</span><span class=\"kg-bookmark-publisher\">TryGhost</span></div></div><div class=\"kg-bookmark-thumbnail\"><img src=\"https://avatars3.githubusercontent.com/u/2178663?s&#x3D;400&amp;v&#x3D;4\" alt></div></a></figure><p>无奈之下自己尝试了一下</p><ol><li>在ghost目录下有个system文件夹，里面存放有systemd的配置文件，</li><li>把这个出错的配置文件更名</li><li>执行 <code>ghost steup systemd</code> 重新建立systemd配置文件</li><li>执行 <code>ghost restart</code> 指令运行程序</li><li>修复成功</li></ol><p>虽然大概知道是配置文件的问题，但是不清楚具体因为什么原因而出错，升级过程中除了ghost-cli的版本过低警告外就是npm的版本更新提示，没出现过其他错误。</p><p>觉得很莫名其妙...。 </p>","date":"4 October 2019","path":"ghostsheng-ji-pai-cuo"}},"context":{}}