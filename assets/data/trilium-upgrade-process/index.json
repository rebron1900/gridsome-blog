{"hash":"03d4e26bc6a7202eb1f57b68d71e0c4979a9960b","data":{"metadata":{"siteName":"只是玩玩 | JUST FUN","siteDescription":"/gridsome-blog"},"post":{"id":"63158312cf533d1c2cf29b71","title":"Trilium升级流程","content":"<p>用Trilium做笔记、知识库管理估摸着也有个把月了把，期间也试过其他笔记软件，如：obsidian、joplin等等，不过都不太满意。我个人还是比较喜欢notion这种all in one的软件，但是notion不能自部署，所以就没有考虑了。</p><p>上次在Trilium那边提了常驻任务栏的issue后得到了作者的肯定说之后某个版本会加进来，所以一直有在关注trilium的更新情况。就在上个星期作者发布了0.49.3的beta，增加了文档分享和常驻任务栏的功能。虽然还有一些bug没修复但是还是挺想尝试的，但是中文版的翻译者nriver觉得很多bug没修复而且是beta版本所以一直没更新。</p><p>终于昨天作者发布了0.49.7的正式版本，nriver终于更新了新版本。在升级过程中踩了一些坑这里记录一下。</p><h3 id=\"%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE\">备份数据</h3><div class=\"kg-card kg-callout-card kg-callout-card-red\"><div class=\"kg-callout-emoji\">⚠️</div><div class=\"kg-callout-text\">进行升级操作前一定要备份好数据！</div></div><p>首先当然是备份数据了，先把docker停掉，然后关闭桌面端后备份软件目录下或者服务端的<code>trilium-data</code>目录下的<code>document.db</code>文件即可。我这里保险起见，直接备份了整个<code>trilium-data</code>目录</p><h3 id=\"%E4%B8%8B%E8%BD%BD%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84pc%E7%AB%AF\">下载新版本的PC端</h3><p>进中文翻译版的github页面直接下来最新的relasea版本就可以了。</p><h3 id=\"%E5%88%A0%E6%8E%89%E6%97%A7%E5%AE%B9%E5%99%A8\">删掉旧容器</h3><p>进入vps后使用<code>sudo docker rm -f tmserver</code>删除旧容器，<code>tmserver</code>为容器名称也可以填容器ID，如果不知道自己的容器名称或者ID可以使用<code>sudo docker ps -a</code>来查看所有容器</p><h3 id=\"%E6%9B%B4%E6%96%B0%E9%95%9C%E5%83%8F\">更新镜像</h3><p>我这里踩了个大坑，现在还不知道怎么回事。</p><p>昨天晚上nriver发布了新版本后我第一时间准备进行更新，为了保险起见，我选择直接删掉旧的镜像重新下载</p><pre><code class=\"language-text-plain\">sudo docker rmi nriver/trilium-cn\nsudo docker pull nriver/trilium-cn</code></pre><p>但是，进行到这里的时候我发现镜像并没有更新，使用<code>sudo docker image ls</code> 可以查看镜像的信息。我反复试了好久，增加latest标签、更换镜像源、使用加速器都不起作用。镜像的更新时间始终显示为6个星期前，也就是上个版本。而且运行信息显示的版本号也不太对。</p><figure class=\"kg-card kg-image-card\"><img src=\"https://cdn.1900.live/202201/tz4omnjf-dwts-3bu-0-rb.jpg\" class=\"kg-image\" alt loading=\"lazy\" width=\"723\" height=\"567\"></figure><p>后来我上群里跟nriver说了一下，他搞到凌晨1点重新打包了镜像。</p><p>但是我第二天pull镜像的时候还是旧版本，后来我在<a href=\"https://hub.docker.com/r/nriver/trilium-cn/tags?ref=1900.live\">hub.docker.com</a>上看docker信息的时候发现有个<code>DIGEST</code>参数，而且在拉去镜像的时候也会显示每个版本的<code>DIGEST</code>信息，所以我试着查了下这东西的相关信息，发现可以手动拉去<code>DIGEST</code>，只要在使用pull的时候加上DIGEST字符串即可。所以我做了以下尝试</p><figure class=\"kg-card kg-image-card\"><img src=\"https://cdn.1900.live/202201/image.png\" class=\"kg-image\" alt loading=\"lazy\" width=\"1336\" height=\"806\"></figure><pre><code class=\"language-text-plain\"># 通过在镜像名称后面增加@sha256:305e882，DIGEST的字符串即可拉取\nsudo docker pull nriver/trilium-cn@sha256:305e882bc24da9da2e24391054a7b187bc25e9e388ed007fb2530b3ed854ca2f\n# 但是这样拉取的镜像TAG是NONE的，我在run的时候报错了，所以我给他加了个latest标签,tag后面是镜像的ID，然后是名称加Tag\nsudo docker tag 61be0df88ced nriver/trilium-cn:latest</code></pre><p>做完这些后我使用run命令重新成功启动了tmserver</p><figure class=\"kg-card kg-image-card kg-width-full\"><img src=\"https://cdn.1900.live/202201/ahpj6em-cirgfeleidlk3x7.jpg\" class=\"kg-image\" alt loading=\"lazy\" width=\"1920\" height=\"1040\"></figure>","date":"8 January 2022","path":"trilium_upgrade_process"}},"context":{}}